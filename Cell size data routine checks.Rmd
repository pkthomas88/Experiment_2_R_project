---
title: "Cell size data routine checks"
output: html_document
---

# Data import and setup

Libraries and data import and removing irrelevant data
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)


library(tidyverse)
library(readxl)
library(ggridges)
library(car)

theme_set(theme_bw()+
  theme(axis.text=element_text(size=12),
  axis.title.x = element_text(size = 16),
  axis.title.y = element_text(size = 16)))

sizechecks <- read_excel("C:/Users/pktho/OneDrive/Experiment 2 ALL SYSTEMATIC PHOTOS/Experiment 2 cell sizes 14.01.21_PTchanges.xlsx", 
    sheet = "all cell measurements")

sizechecks <- sizechecks[1:17]
sizechecks <- sizechecks %>% 
  filter(entrant!="PT") %>% 
  mutate(distance=distance/1000) %>% 
  select(-angle) %>% 
  mutate(species=ifelse(species=="thalasso", "tnema", species))
  #because it thinks commas are thousands and not decimal point but careful with this!!

```

Checking that the dimensions make sense for each species. On second thought though I think this would be best to check in excel to make sure I change errors to the right dimension (like would 'l' for dity really be h or w?)

```{r eval=FALSE, include=FALSE}
#yeah for example there are some that have dimension labels that will cause problems
sizechecks %>% filter(species =='dity', dimension == 'l')

#the only way I can think to di this now is to separate by species
dity <- subset(sizechecks, species=="dity")
rhizo <- subset(sizechecks, species=="rhizo")
tnema <- subset(sizechecks, species=="tnema")

dity %>% filter(dimension == 'l')

dity <- dity %>% 
  mutate(dimension=ifelse(dimension=='l', 'h', dimension))

dity %>% filter(dimension == 'l')

##^^example of how I might do this but holding off on this for now**



```


Filtering and checking numbers of observations by treatments and then by each plate/well combination

**so far this is total obs not total number of cells so maybe move to after pivoting and mutating stuff**

```{r}

#checks where data is generally sparse or not

grouped <- sizechecks %>% group_by(nuts, temp, species_richness, strains) %>% 
  summarize(count=n())

ggplot(grouped, aes(strains, count))+
  geom_point()+
  facet_grid(temp~species_richness)

#checks which wells have been done already

grouped2 <- sizechecks %>% group_by(plate, well, species_richness, strains, nuts, temp) %>% 
  summarize(count=n())
```

Check where the problems are so pivot_wider doesn't drive me crazy

```{r}
#makes an object of all the cell_ids that appear too many times

cell_id_checks <- sizechecks %>% 
  count(cell_id) %>% 
  filter(n>2)

biovolumes_wide <- sizechecks %>%
  pivot_wider(names_from = dimension,
              values_from = distance,
              values_fn = length,
              id_cols = cell_id)

#not sure why this gives a different number than the chunk above where it gives 56 with too many cell_ids, this gives 174??

```

Using pivot wider to check if there are errors with cell_id (more than one or 2 per cell id = problematic)

```{r}


biovolumes_wide_check_counts <- biovolumes_wide %>% filter(h>1 | w>1 | d>1 | h>1)
```

For now, attempting to exclude ones where the cell_ids are weird, but for the final analysis need to either manually fix those in excel, since that might be tough to do in R

> And even after I exclude the weird ones it still gives issues with pivot_wider :/

```{r}
#join the object with all the weird cell_ids and filter those out since those are the only nas, which gets ride of a couple hundred rows
biovolumes_wide_clean <- left_join(sizechecks, cell_id_checks) %>%
  filter(is.na(n))

biovolumes_wide_clean2 <- biovolumes_wide_clean %>%
  pivot_wider(names_from = dimension,
              values_from = distance, values_fn=length)

biovolumes_wide_check_counts <- biovolumes_wide_clean2 %>% filter(h>1 | w>1 | d>1 | h>1)

bad <- biovolumes_wide_check_counts[11] %>% 
  mutate(badrows='bad')

biovolumes_wide_clean3 <- left_join(sizechecks, bad) %>% 
  filter(is.na(badrows))

biovolumes_wide_clean4 <- biovolumes_wide_clean3 %>%
  select(cell_id, dimension, distance) %>% 
  pivot_wider(names_from = dimension,
              values_from = distance)

              
              
```

Since pivot_wider is being really shitty, I'll just take the mean values for things that are weird, but this needs to be fixed

```{r}

biovolumes_wide <- sizechecks %>%
  pivot_wider(names_from = dimension,
              values_from = distance,
              values_fn = mean) #mean == wrong, so do it right later
              #id_cols = cell_id)

```

Separating the broken vs non-broken cells, separating species

```{r}
notbroken <- filter(biovolumes_wide, is.na(broken))
broken <- biovolumes_wide %>% filter(broken==1)
```

Attempting to deal with the broken cells correctly

1. make objects for each species
2. calculate mean ratio of measured dimensions
3. use mutate to calculate unmeasured dimensions

```{r}
dity_intact <- subset(notbroken, species=="dity")
rhizo_intact <- subset(notbroken, species=="rhizo")
tnema_intact <- subset(notbroken, species=="tnema")

dity_mean_ratio <- mean(dity_intact$h/dity_intact$w, na.rm = TRUE)

rhizo_mean_ratio <- mean(rhizo_intact$h/rhizo_intact$d, na.rm=TRUE)

tnema_mean_ratio <- mean(tnema_intact$l/tnema_intact$h, na.rm = TRUE)

broken <- broken %>% 
  mutate(h = ifelse(species=='dity', w*dity_mean_ratio, h)) %>% 
  mutate(h = ifelse(species=='rhizo', d*rhizo_mean_ratio, h)) %>%
  mutate(l = ifelse(species=='tnema', h*tnema_mean_ratio, l))
  
biovolumes_with_broken <- bind_rows(dity_intact, rhizo_intact, tnema_intact, broken)

biovolumes_with_broken <- biovolumes_with_broken %>%
  mutate(biov='NA') %>% 
  mutate(biov = ifelse(species=='dity', w*w*h/2, biov)) %>% 
  mutate(biov = ifelse(species=='rhizo', (pi/4)*d^2*h, biov)) %>%
  mutate(biov = ifelse(species=='tnema', l*h*h, biov)) %>% 
  mutate(biov=as.integer(biov))

biovolumes_with_broken <- biovolumes_with_broken %>% 
  mutate(AR ='NA') %>%
  mutate(AR = ifelse(species=='dity', h/w, AR)) %>% 
  mutate(AR = ifelse(species=='rhizo', h/d, AR)) %>%
  mutate(AR = ifelse(species=='tnema', l/h, AR)) %>% 
  mutate(AR=as.numeric(AR))

```


```{r}
mono_biov <- filter(biovolumes_with_broken, species_richness==1, strains==1)

highdiv_biov <- filter(biovolumes_with_broken, species_richness==3, strains==3)

```


# Effects of environment on cell sizes

## monocultures
```{r}

#COOL fake data!

ggplot(mono_biov, aes(x = biov, y = div_tx))+
  geom_density_ridges()+
  scale_x_log10()
  
ggplot(mono_biov, aes(x = biov, y = as.factor(temp)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

ggplot(mono_biov, aes(x = biov, y = as.factor(nuts)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

ggplot(mono_biov, aes(x = as.factor(temp), y = biov, fill=nuts))+
  facet_wrap(~div_tx, scales = 'free')+
  geom_violin()+
  scale_y_log10()

ggplot(mono_biov, aes(x = as.factor(temp), y = biov, fill=nuts))+
  facet_wrap(~div_tx, scales = 'free')+
  geom_boxplot()+
  scale_y_log10()

```

## 3 species 3 strains

Density plots of size by temperature for high diversity treatments

```{r}
ggplot(highdiv_biov, aes(x = biov, y = as.factor(temp)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

ggplot(highdiv_biov, aes(x = biov, y = as.factor(nuts)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

ggplot(highdiv_biov, aes(biov))+
  geom_density()+
  facet_grid(temp~nuts)+
  scale_x_log10()

ggplot(highdiv_biov, aes(as.factor(temp), biov,  fill=nuts))+
  geom_boxplot()+
  scale_y_log10()

ggplot(highdiv_biov, aes(as.factor(temp), biov,  fill=nuts))+
  geom_violin()+
  scale_y_log10()

```

## All diversity treatments

```{r}
ggplot(biovolumes_with_broken, aes(x = biov, y = as.factor(temp)))+
  geom_density_ridges()+
  scale_x_log10()

ggplot(biovolumes_with_broken, aes(x = biov, y = as.factor(nuts)))+
  geom_density_ridges()+
  scale_x_log10()

ggplot(biovolumes_with_broken, aes(biov))+
  geom_density()+
  facet_grid(temp~nuts)+
  scale_x_log10()
```

# Effects of species and strain richness on size diversity

```{r}

size_by_well <- biovolumes_with_broken %>% 
  group_by(plate, well, species_richness, strains, temp, nuts) %>%
  summarize(var_biov=var(biov),
            mean_biov=mean(biov),
            CV_biov=sd(biov)/mean(biov))

allmaxRFUandfits <- read_csv("allmaxRFUandfits17.7.20_withK400allowed.csv")

sizesandRFU <- left_join(allmaxRFUandfits, size_by_well) %>% 
  mutate(totalstrains=species_richness*strains)

```

```{r}
ggplot(sizesandRFU, aes(species_richness, CV_biov))+
  geom_point()+
  #geom_smooth(method="lm")+
  stat_smooth(method = "lm", formula = y ~ x + I(x^2))+
  xlab("Species richness")+
  ylab("Cell size variation (CV)")+
  scale_x_continuous(breaks=c(1,2,3))+
  scale_y_log10()


ggplot(sizesandRFU, aes(strains, CV_biov))+
  geom_point()+
  #geom_smooth(method="lm")+
  stat_smooth(method = "lm", formula = y ~ x + I(x^2))+
  xlab("Strain richness per species")+
  ylab("Cell size variation (CV)")+
  scale_x_continuous(breaks=c(1,2,3))+
  scale_y_log10()

ggplot(sizesandRFU, aes(strains, CV_biov))+
  geom_point()+
  #geom_smooth(method="lm")+
  stat_smooth(method = "lm", formula = y ~ x + I(x^2))+
  xlab("Strain richness per species")+
  ylab("Cell size variation (CV)")+
  scale_x_continuous(breaks=c(1,2,3))+
  scale_y_log10()+
  facet_grid(temp~species_richness)

fit <- lm(data=sizesandRFU, CV_biov~species_richness*strains)
summary(fit)
avPlots(fit)

fit <- lm(data=sizesandRFU, CV_biov~species_richness*strains*temp*nuts)
summary(fit)
avPlots(fit)
```



# Calculation of biovolume per ml

```{r}
```

# Shapes

```{r}

ggplot(mono_biov, aes(x = AR, y = div_tx))+
  geom_density_ridges()+
  scale_x_log10()
  
ggplot(mono_biov, aes(x = AR, y = as.factor(temp)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

ggplot(mono_biov, aes(x = AR, y = as.factor(nuts)))+
  geom_density_ridges()+
  facet_wrap(~div_tx)+
  scale_x_log10()

```

## All diversity treatments

```{r}
ggplot(biovolumes_with_broken, aes(x = AR, y = as.factor(temp)))+
  geom_density_ridges()+
  scale_x_log10()

ggplot(biovolumes_with_broken, aes(x = AR, y = as.factor(nuts)))+
  geom_density_ridges()+
  scale_x_log10()

ggplot(biovolumes_with_broken, aes(AR))+
  geom_density()+
  facet_grid(temp~nuts)+
  scale_x_log10()
```


```{r}
mono_biov %>% 
  filter(!is.na(biov), !is.na(AR), is.na(broken)) %>% 
  ggplot(aes(biov, AR, color=species))+
  geom_point()+
  scale_x_log10()+
  scale_y_log10()

mono_biov %>% 
  filter(!is.na(biov), !is.na(AR), is.na(broken)) %>% 
  ggplot(aes(biov, AR, color=div_tx))+
  geom_point(size=2)+
  scale_x_log10()+
  scale_y_log10()

```

for ppt

```{r}

mono_biov %>% 
  filter(is.na(broken)) %>% 
  ggplot(aes(x = biov, y = div_tx))+
  geom_density_ridges()+
  scale_x_log10()+
  xlab("biovolume")+
  ylab("strain")


mono_biov %>% 
  filter(is.na(broken)) %>% 
  ggplot(aes(x = AR, y = div_tx))+
  geom_density_ridges()+
  scale_x_log10()+
  xlab("aspect ratio")+
  ylab("strain")

mono_biov %>% 
  filter(is.na(broken)) %>% 
  ggplot(aes(biov, AR, color=div_tx))+
  geom_point(size=2)+
  scale_x_log10()+
  scale_y_log10()+
  xlab("biovolume")+
  ylab("aspect ratio")


```


